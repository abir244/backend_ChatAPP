// src/index.js - SIMPLE WORKING VERSION
import { readFileSync } from 'fs';
import { resolve } from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// 1. MANUALLY LOAD .env FILE - GUARANTEED TO WORK
console.log('=== Loading environment ===');
try {
  const envPath = resolve(__dirname, '..', '.env');
  console.log('Looking for .env at:', envPath);
  
  const content = readFileSync(envPath, 'utf8');
  console.log('âœ… .env file found and readable');
  
  const lines = content.split('\n');
  let loadedCount = 0;
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const equalsIndex = trimmed.indexOf('=');
      if (equalsIndex > 0) {
        const key = trimmed.substring(0, equalsIndex).trim();
        const value = trimmed.substring(equalsIndex + 1).trim();
        process.env[key] = value;
        loadedCount++;
        console.log(`   Loaded: ${key}`);
      }
    }
  }
  
  console.log(`âœ… Loaded ${loadedCount} environment variables\n`);
} catch (error) {
  console.error('âŒ CRITICAL: Cannot load .env file:', error.message);
  console.error('Make sure .env file exists in project root');
  process.exit(1);
}

// 2. NOW IMPORT EVERYTHING ELSE
import http from 'http';
import { Server } from 'socket.io';
import app from './app.js';
import connectDB from './config/database.js';
import { saveMessage, getMessages } from './controllers/chatController.js';

// 3. VERIFY ENVIRONMENT IS LOADED
console.log('=== Environment Verification ===');
console.log('PORT:', process.env.PORT);
console.log('MONGODB_URI exists:', !!process.env.MONGODB_URI);

if (!process.env.MONGODB_URI) {
  console.error('âŒ MONGODB_URI is not defined!');
  process.exit(1);
}

// 4. CONNECT TO DATABASE
console.log('\n=== Database Connection ===');
connectDB();

// 5. START SERVER
const PORT = process.env.PORT || 4000;
const server = http.createServer(app);

const io = new Server(server, {
  cors: { origin: '*' }
});

io.on('connection', async (socket) => {
  console.log(`âœ… User connected: ${socket.id}`);

  try {
    const messages = await getMessages();
    socket.emit('chat_history', messages);
    console.log(`ðŸ“œ Sent ${messages.length} messages to ${socket.id}`);
  } catch (err) {
    console.error('âŒ Error fetching chat history:', err);
  }

  socket.on('send_message', async (data) => {
    try {
      const saved = await saveMessage(data);
      io.emit('receive_message', saved);
    } catch (err) {
      console.error('âŒ Error saving message:', err);
    }
  });

  socket.on('disconnect', () => {
    console.log(`âŒ User disconnected: ${socket.id}`);
  });
});

server.listen(PORT, () => {
  console.log(`\nðŸš€ Server running on http://localhost:${PORT}`);
  console.log('========================================');
});
